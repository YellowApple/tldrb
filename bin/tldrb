#!/usr/bin/env ruby

require 'open-uri'
require 'optparse'

def get_page(query, platform)
  url = "https://raw.github.com/tldr-pages/tldr/master/pages/" \
        "#{platform}/#{query}.md"
  open(url).read
rescue StandardError
  nil
end

def my_platform
  platform = Gem::Platform.local.os
  # TODO: suggest upstream use of "darwin" instead of "osx", since
  # "darwin" is what is actually used by OS X internally"
  platform = 'osx' if platform == 'darwin'
  platform
end

platform = my_platform

help = OptionParser.new do |opts|
  opts.banner = <<-BANNER.gsub(/^ {4}/, "")
    Ruby client for tldr https://github.com/tldr-pages/tldr
  BANNER
  opts.on("-o", "--os", "Override the operating system [linux, osx, sunos]") { |o| platform = o }
  opts.on("-h", "--help", "Show this.") { puts opts; exit }
  opts.on("-v", "--version", "Show Version") { puts "0.0.2"; exit }
end
help.parse!(ARGV)

if ARGV.size != 1
  puts help
  exit 1
end

query = ARGV[0]
result = get_page query, platform
result = get_page query, 'common' unless result

if result
  # TODO: markdown formatting
  puts result
else
  puts "Couldn't find a tldr for '#{query}'."
end
